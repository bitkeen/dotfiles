#!/bin/sh
# Tmux dropdown launch script.
#
# Arguments:
# $1 - terminal window name
# $2 - tmux session to attach to

[ -z "$1" ] && exit 1

DD_NAME='tmux-dropdown'
SESSION_NAME="$1"
TMUX_CMD="tmux new-session -A -s ${SESSION_NAME}"
ZSH_CMD="zsh -i -c '${TMUX_CMD}'"


launch_new_terminal() {
    # Tmux dropdown is not running.
    swaymsg "exec ${TERMINAL} --app-id ${DD_NAME} -e ${ZSH_CMD}"

    # Wait until terminal is up.
    while pgrep -fa --runstates 'R' "${TERMINAL} --app-id ${DD_NAME}"; do
        sleep .05
    done
}


existing_dd="$(pgrep -fa "${TERMINAL} --app-id ${DD_NAME}")"
if [ -n "${existing_dd}" ]; then
    # Tmux dropdown is already running.
    attached_session="$(echo "${existing_dd}" | awk '{ print $NF }')"
    if [ "${attached_session}" != "${SESSION_NAME}" ]; then
        # Attached session is different from the one passed in
        # arguments. Kill the terminal and launch a new one.
        existing_dd_pid="$(echo "${existing_dd}" | awk '{ print $1 }')"
        kill "${existing_dd_pid}"
        launch_new_terminal
    fi
else
    # Tmux dropdown is not running.
    launch_new_terminal
fi

# Show dropdown window.
swaymsg "[app_id=\"${DD_NAME}\"] scratchpad show; [app_id=\"${DD_NAME}\"] move position center"
